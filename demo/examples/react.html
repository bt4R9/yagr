<html>
    <head>
        <title>Yagr:: Dynamic Updates</title>
        <script>
            process = {
                env: {},
            };
        </script>
        <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="../../dist/yagr.iife.js"></script>
        <link rel="stylesheet" href="../../dist/index.css" />
        <style>
            .container {
                margin-bottom: 26px;
                height: 400px;
                width: 100%;
            }
            .grid {
                height: 450px;
                display: flex;
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
            }
        </style>
    </head>
    <body>
        <div class="grid">
            <div class="container">
                <div id="chart1"></div>
            </div>
            <div class="container">
                <pre id="hooktrace"></pre>
            </div>
        </div>

        <div class="grid">
            <div class="container">
                <div id="chart2"></div>
            </div>
            <div class="container">
                <pre id="hooktrace2"></pre>
            </div>
        </div>

        <script type="text/babel">
            let tstart = Date.now();

            class YagrChartComponent extends React.Component {
                charRef = React.createRef();

                componentDidMount() {
                    this.initChart();
                }

                componentDidUpdate() {
                    if (this.chart) {
                        this.chart.dispose();
                    }

                    this.initChart();
                }

                componentWillUnmount() {
                    if (this.chart) {
                        this.chart.dispose();
                    }
                }

                render() {
                    const {id, className} = this.props;

                    return (
                        <div id={id} onClick={this.onClick} className={`yagr ${className || ''}`} ref={this.charRef} />
                    );
                }

                onClick = (event) => {
                    if (this.chart && (event.ctrlKey || event.metaKey) && event.shiftKey) {
                        const dataUrl = this.chart.toDataUrl().replace('image/png', 'image/octet-stream');
                        const a = document.createElement('a');
                        a.href = dataUrl;
                        a.download = (this.props.debug?.filename || this.chart.id) + '.png';
                        a.click();
                    }
                };

                initChart() {
                    if (!this.charRef.current) {
                        return;
                    }
                    const {onChartLoad, config, onSelect} = this.props;

                    config.hooks = config.hooks || {};
                    const hooks = config.hooks;

                    if (onChartLoad) {
                        const load = hooks.load || [];
                        load.push(({chart, meta}) => {
                            onChartLoad(chart, meta);
                        });
                        hooks.load = load;
                    }

                    if (onSelect) {
                        const selection = hooks.onSelect || [];
                        selection.push(({from, to}) => onSelect(from, to));
                        hooks.onSelect = selection;
                    }

                    this.chart = new Yagr(this.charRef.current, this.props.config);
                }
            }

            function YagrReact({id, config, className = '', debug, onChartLoad, onSelect}) {
                const chartRef = React.useRef(null);
                const chart = React.useRef(undefined);

                const initChart = React.useCallback(() => {
                    if (chartRef.current) {
                        chart.current = new Yagr(chartRef.current, config);

                        config.hooks = config.hooks || {};
                        const hooks = config.hooks;

                        if (onChartLoad) {
                            const load = hooks.load || [];
                            load.push(({chart, meta}) => {
                                onChartLoad(chart, meta);
                            });
                            hooks.load = load;
                        }

                        if (onSelect) {
                            const selection = hooks.onSelect || [];
                            selection.push(({from, to}) => onSelect(from, to));
                            hooks.onSelect = selection;
                        }
                    }
                }, []);

                React.useEffect(() => {
                    config && chart.current?.setConfig(config);
                }, [config]);

                React.useEffect(() => {
                    initChart();
                    return () => chart.current?.dispose();
                }, []);

                const onClick = React.useCallback(
                    (event) => {
                        if (chart.current && (event.ctrlKey || event.metaKey) && event.shiftKey) {
                            const dataUrl = chart.current.toDataUrl().replace('image/png', 'image/octet-stream');
                            const a = document.createElement('a');
                            a.href = dataUrl;
                            a.download = (debug?.filename || chart.current.id) + '.png';
                            a.click();
                        }
                    },
                    [id, chart],
                );

                return <div id={id} onClick={onClick} className={`yagr ${className}`} ref={chartRef} />;
            }

            const prepData = {
                timelines: new Array(500)
                    .fill(0)
                    .map((_, i) => new Array(20).fill(0).map((_, j) => (i + 5) * 500 * 20 + j * 1000)),
                series: new Array(500).fill(0).map((_, i) =>
                    new Array(15).fill(0).map((_, j) => ({
                        data: new Array(20).fill(0).map((_, j) => Math.random() * 1000),
                        id: `${j}`,
                        color: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 1)`,
                    })),
                ),
            };

            function Perf() {
                const [i, setI] = React.useState(1);
                const [config, setConfig] = React.useState({
                    timeline: prepData.timelines[0],
                    series: prepData.series[0],
                    hooks: {
                        onSelect: [
                            ({from, to}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - onSelect. from=${from}, to=${to} \n`;
                            },
                        ],
                        processed: [
                            ({meta}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - processed. time=${meta.processTime}ms. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        inited: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - inited. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        dispose: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - dispose. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        resize: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - resize. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        stage: [
                            ({stage}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - stage=${stage}. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        ready: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - ready. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        load: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace.innerHTML += ` - load. Passed: ${tpassed}ms\n`;
                            },
                        ],
                    },
                });

                const startPerf = React.useCallback(() => {
                    let i = 1;
                    let id = setInterval(() => {
                        if (!prepData.timelines[i]) {
                            return clearInterval(id);
                        }
                        hooktrace.innerHTML = '';
                        setConfig((prev) => ({
                            ...prev,
                            timeline: prepData.timelines[i],
                            series: prepData.series[i],
                        }));
                        i++;
                    }, 300);
                }, [config, setConfig, setI, i]);

                return (
                    <div className="container">
                        <YagrChartComponent config={config} />
                        <button onClick={startPerf}>Start</button>
                        <button onClick={() => (hooktrace.innerHTML = '')}>Clear</button>
                    </div>
                );
            }

            function PerfOld() {
                const [i, setI] = React.useState(1);
                const [config, setConfig] = React.useState({
                    timeline: prepData.timelines[0],
                    series: prepData.series[0],
                    hooks: {
                        onSelect: [
                            ({from, to}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - onSelect. from=${from}, to=${to} \n`;
                            },
                        ],
                        processed: [
                            ({meta}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - processed. time=${meta.processTime}ms. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        inited: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - inited. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        dispose: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - dispose. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        resize: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - resize. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        stage: [
                            ({stage}) => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - stage=${stage}. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        ready: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - ready. Passed: ${tpassed}ms\n`;
                            },
                        ],
                        load: [
                            () => {
                                const tpassed = Date.now() - tstart;
                                hooktrace2.innerHTML += ` - load. Passed: ${tpassed}ms\n`;
                            },
                        ],
                    },
                });

                const startPerf = React.useCallback(() => {
                    let i = 1;
                    let id = setInterval(() => {
                        if (!prepData.timelines[i]) {
                            return clearInterval(id);
                        }
                        hooktrace2.innerHTML = '';
                        setConfig((prev) => ({
                            ...prev,
                            timeline: prepData.timelines[i],
                            series: prepData.series[i],
                        }));
                        i++;
                    }, 300);
                }, [config, setConfig, setI, i]);

                return (
                    <div className="container">
                        <YagrChartComponent config={config} />
                        <button onClick={startPerf}>Start</button>
                        <button onClick={() => (hooktrace.innerHTML = '')}>Clear</button>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(chart1);
            root.render(<Perf />);

            const root2 = ReactDOM.createRoot(chart2);
            root2.render(<PerfOld />);
        </script>
    </body>
</html>
